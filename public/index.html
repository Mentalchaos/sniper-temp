<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SNIPER DASHBOARD V90 - STEALTH</title>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
        h1 { color: #f0a500; text-align: center; font-size: 24px; margin-bottom: 20px; letter-spacing: 1px; }
        
        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        #startBtn { background: #238636; color: white; }
        #startBtn:hover { background: #2ea043; }
        #stopBtn { background: #da3633; color: white; }
        
        table { width: 100%; border-collapse: collapse; background: #161b22; border-radius: 6px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #30363d; font-size: 13px; vertical-align: middle; }
        th { background: #21262d; color: #8b949e; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }
        tr:hover { background-color: #1c2128; }

        .val-green { color: #3fb950; font-weight: bold; }
        .val-red { color: #f85149; font-weight: bold; }
        .val-cyan { color: #388bfd; }
        .val-gold { color: #e3b341; font-size: 11px; }
        
        /* ESTILOS DE SE√ëALES */
        .sig-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
        .sig-bank { background: #d29922; color: #fff; border: 1px solid #e3b341; box-shadow: 0 0 8px #d29922; animation: pulse 2s infinite; }
        .sig-pred { background: #6e40c9; color: #fff; border: 1px solid #8957e5; box-shadow: 0 0 5px #8957e5; }
        .sig-break { background: #b31d28; color: #fff; border: 1px solid #fdaeb7; animation: pulse 1.5s infinite; }
        .sig-reach { background: #1f6feb; color: #fff; border: 1px solid #388bfd; }
        .sig-wait { background: #30363d; color: #8b949e; }
        .sig-rain { background: #161b22; color: #58a6ff; border: 1px solid #1f6feb; }
        
        /* SE√ëAL DE SALIDA (EXIT) */
        .sig-exit { background: #ff0000; color: #fff; border: 1px solid #ff4444; animation: flash 0.5s infinite; font-weight: 900; }

        .stake-box { background: #238636; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-family: monospace; }
        .edge-info { font-size: 13px; color: #a2a9b1; margin-top: 4px; font-weight: 500; }
        
        .trade-btn { 
            background: transparent; color: #58a6ff; border: 1px solid #30363d; 
            padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; text-decoration: none; font-size: 11px;
        }
        .trade-btn:hover { background: #30363d; color: #fff; }

        /* BOT√ìN DE TRACKING */
        .track-btn {
            background: transparent; border: 1px solid #30363d; color: #8b949e;
            padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 11px; transition: 0.2s;
        }
        .track-btn.active {
            background: #f0a500; color: #0d1117; border-color: #f0a500; box-shadow: 0 0 5px #f0a500;
        }

        .toast {
            position: fixed; bottom: 20px; right: 20px; background: #238636; color: #fff;
            padding: 10px 20px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes flash { 0% { background-color: #ff0000; } 50% { background-color: #500000; } 100% { background-color: #ff0000; } }
    </style>
</head>
<body>
    <h1>SNIPER V90 - STEALTH</h1>
    <div class="controls">
        <button id="startBtn" onclick="toggleBot(true)">‚ñ∂ ACTIVAR SISTEMA</button>
        <button id="stopBtn" onclick="toggleBot(false)">‚èπ DETENER</button>
    </div>
    <table id="targetTable">
        <thead>
            <tr>
                <th>Mercado</th>
                <th>Hora Local</th> <th>Temp</th>
                <th>Dev</th>
                <th>Tend</th>
                <th>Max Hoy</th>
                <th>Target (Exp)</th> 
                <th>Se√±al Sniper</th>
                <th>Stake / Edge</th>
                <th>Posici√≥n</th> 
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="toast" class="toast">¬°Copiado!</div>

    <script>
        let isRunning = false;

        async function toggleBot(state) {
            await fetch(state ? '/api/start' : '/api/stop', { method: 'POST' });
            isRunning = state;
        }

        async function toggleTrack(cityId) {
            await fetch('/api/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: cityId })
            });
            update(); 
        }

        function formatTemp(unit, val) {
            if (val === null || val === -999) return "--";
            return unit === 'F' ? (val * 9/5 + 32).toFixed(1) + "¬∞F" : val.toFixed(1) + "¬∞C";
        }

        function getSignalHtml(signal) {
            let icon = "";
            let cssClass = "sig-wait";

            if (signal.includes("EXIT")) { icon = "üö®"; cssClass = "sig-exit"; }
            else if (signal.includes("BANK")) { icon = "üí∞"; cssClass = "sig-bank"; }
            else if (signal.includes("PREDICTION")) { icon = "üîÆ"; cssClass = "sig-pred"; }
            else if (signal.includes("SCALP") || signal.includes("BREAK")) { icon = "üî•"; cssClass = "sig-break"; }
            else if (signal.includes("REACH")) { icon = "üéØ"; cssClass = "sig-reach"; }
            else if (signal.includes("RAIN")) { icon = "üåßÔ∏è"; cssClass = "sig-rain"; }
            else if (signal.includes("NO TRADE")) { icon = "‚õî"; cssClass = "sig-wait"; }
            else if (signal.includes("WAIT")) { icon = "‚úã"; cssClass = "sig-wait"; }
            else if (signal.includes("CALIBRATING")) { icon = "‚è≥"; cssClass = "sig-wait"; }
            
            return `<span class="sig-badge ${cssClass}">${icon} ${signal}</span>`;
        }

        async function tradeAction(url, amount) {
            if (amount && amount !== '--' && amount !== '0') {
                try {
                    await navigator.clipboard.writeText(amount);
                    showToast(`Stake copiado: $${amount}`);
                } catch (err) { console.log("Clipboard error"); }
            }
            window.open(`https://polymarket.com/event/${url}`, '_blank');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = 1;
            setTimeout(() => toast.style.opacity = 0, 2000);
        }

        async function update() {
            if (!isRunning) return;
            try {
                const res = await fetch('/api/data');
                const data = await res.json();
                const body = document.getElementById('tableBody');
                
                if (!data || data.length === 0) return;

                body.innerHTML = '';
                
                data.forEach(d => {
                    const tr = document.createElement('tr');
                    
                    let tradeHtml = `<span style="color:#444">--</span>`;
                    if (d.fullSlug && d.fullSlug.length > 5) {
                        const stakeVal = (d.stake !== '--' && d.stake !== '0.00') ? d.stake : '0';
                        tradeHtml = `<button onclick="tradeAction('${d.fullSlug}', '${stakeVal}')" class="trade-btn">LINK ‚Üó</button>`;
                    }

                    const stakeDisplay = (d.stake !== '--' && d.stake !== '0.00') 
                        ? `<span class="stake-box">$${d.stake}</span>` 
                        : `<span style="color:#555">--</span>`;

                    const trackBtn = `<button onclick="toggleTrack('${d.id}')" class="track-btn ${d.isTracking ? 'active' : ''}">
                        ${d.isTracking ? 'üõ∞Ô∏è TRACKING' : 'TRACK'}
                    </button>`;

                    tr.innerHTML = `
                        <td style="font-weight:bold; color:#e6edf3">${d.id}</td>
                        <td style="color:#8b949e; font-family:monospace">${d.timer}</td> <td class="val-cyan">${formatTemp(d.unit, d.curC)}</td>
                        <td class="${parseFloat(d.devDisp) >= 0 ? 'val-green' : 'val-red'}">${d.devDisp}</td>
                        <td>${d.trend}</td>
                        <td style="color:#d2a8ff; font-weight:bold">${formatTemp(d.unit, d.high)}</td>
                        <td style="color:#f0a500; font-weight:bold">${d.targetDisp || '--'}</td>
                        <td>${getSignalHtml(d.signal)}</td>
                        <td>
                            ${stakeDisplay} 
                            <div class="edge-info">${d.priceDisp}</div>
                        </td>
                        <td>${trackBtn}</td>
                        <td>${tradeHtml}</td>
                    `;
                    body.appendChild(tr);
                });
            } catch (e) {}
        }
        setInterval(update, 2000);
    </script>
</body>
</html>